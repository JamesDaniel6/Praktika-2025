# -*- coding: utf-8 -*-
# coding: utf-8
import telebot
import random
import time
from telebot import types

BOT_TOKEN = "7711127822:AAEEIapQP7OMJs9hoyHFutobk43azFV0sjo"
bot = telebot.TeleBot(BOT_TOKEN)

# --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è "–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ" ---
guess_min = 1
guess_max = 100
guess_number = 0
secret_number = 0
attempts = 0

# --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è "–û—Ä–µ–ª –∏ —Ä–µ—à–∫–∞" ---
coin_side = ""

# --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è "–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏" ---
board = ['‚¨ú'] * 9  # –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–æ—Å–∫—É –±–µ–ª—ã–º–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞–º–∏
current_player = 'X'  # 'X' - –∏–≥—Ä–æ–∫, 'O' - –±–æ—Ç

# --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ---
def show_main_menu(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    rps = types.KeyboardButton("–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞")
    bot_guess = types.KeyboardButton("–ë–æ—Ç —É–≥–∞–¥—ã–≤–∞–µ—Ç —á–∏—Å–ª–æ")
    user_guess = types.KeyboardButton("–Ø —É–≥–∞–¥—ã–≤–∞—é —á–∏—Å–ª–æ")
    coin_flip = types.KeyboardButton("–û—Ä–µ–ª –∏ —Ä–µ—à–∫–∞")
    russian_roulette = types.KeyboardButton("–†—É—Å—Å–∫–∞—è —Ä—É–ª–µ—Ç–∫–∞")
    tic_tac_toe = types.KeyboardButton("–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏")  # –ù–æ–≤–∞—è –∏–≥—Ä–∞
    markup.add(rps, bot_guess, user_guess, coin_flip, russian_roulette, tic_tac_toe)
    bot.send_message(message.chat.id, "–í–æ —á—Ç–æ —Å—ã–≥—Ä–∞–µ–º?", reply_markup=markup)

@bot.message_handler(commands=['start'])
def start(message):
    show_main_menu(message)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∏–≥—Ä—ã ---
@bot.message_handler(func=lambda message: message.text in ["–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞", "–ë–æ—Ç —É–≥–∞–¥—ã–≤–∞–µ—Ç —á–∏—Å–ª–æ", "–Ø —É–≥–∞–¥—ã–≤–∞—é —á–∏—Å–ª–æ", "–û—Ä–µ–ª –∏ —Ä–µ—à–∫–∞", "–†—É—Å—Å–∫–∞—è —Ä—É–ª–µ—Ç–∫–∞", "–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏"])
def choose_game(message):
    if message.text == "–ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞":
        rock_paper_scissors(message)
    elif message.text == "–ë–æ—Ç —É–≥–∞–¥—ã–≤–∞–µ—Ç —á–∏—Å–ª–æ":
        bot_guess_number(message)
    elif message.text == "–Ø —É–≥–∞–¥—ã–≤–∞—é —á–∏—Å–ª–æ":
        user_guess_number(message)
    elif message.text == "–û—Ä–µ–ª –∏ —Ä–µ—à–∫–∞":
        coin_flip(message)
    elif message.text == "–†—É—Å—Å–∫–∞—è —Ä—É–ª–µ—Ç–∫–∞":
        russian_roulette(message)
    elif message.text == "–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏":
        start_tic_tac_toe(message)

# --- –ö–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞ ---
def rock_paper_scissors(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    rock = types.KeyboardButton("–ö–∞–º–µ–Ω—å")
    paper = types.KeyboardButton("–ë—É–º–∞–≥–∞")
    scissors = types.KeyboardButton("–ù–æ–∂–Ω–∏—Ü—ã")
    markup.add(rock, paper, scissors)
    bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏: –ö–∞–º–µ–Ω—å, –ù–æ–∂–Ω–∏—Ü—ã –∏–ª–∏ –ë—É–º–∞–≥–∞?", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text in ["–ö–∞–º–µ–Ω—å", "–ë—É–º–∞–≥–∞", "–ù–æ–∂–Ω–∏—Ü—ã"])
def handle_rps_choice(message):
    user_choice = message.text
    bot_choice = random.choice(["–ö–∞–º–µ–Ω—å", "–ë—É–º–∞–≥–∞", "–ù–æ–∂–Ω–∏—Ü—ã"])

    if user_choice == bot_choice:
        result = "–ù–∏—á—å—è!"
    elif (user_choice == "–ö–∞–º–µ–Ω—å" and bot_choice == "–ù–æ–∂–Ω–∏—Ü—ã") or \
         (user_choice == "–ù–æ–∂–Ω–∏—Ü—ã" and bot_choice == "–ë—É–º–∞–≥–∞") or \
         (user_choice == "–ë—É–º–∞–≥–∞" and bot_choice == "–ö–∞–º–µ–Ω—å"):
        result = "–¢—ã –≤—ã–∏–≥—Ä–∞–ª!"
    else:
        result = "–Ø –≤—ã–∏–≥—Ä–∞–ª!"

    bot.send_message(message.chat.id, f"–¢—ã –≤—ã–±—Ä–∞–ª: {user_choice}\n–Ø –≤—ã–±—Ä–∞–ª: {bot_choice}\n–†–µ–∑—É–ª—å—Ç–∞—Ç: {result}", reply_markup=types.ReplyKeyboardRemove())
    show_main_menu(message)  # –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

# --- –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ (–ë–æ—Ç —É–≥–∞–¥—ã–≤–∞–µ—Ç) ---
def bot_guess_number(message):
    global guess_min, guess_max, guess_number
    guess_min = 1
    guess_max = 100
    guess_number = (guess_min + guess_max) // 2  # –ü–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    higher = types.KeyboardButton("–ë–æ–ª—å—à–µ")
    lower = types.KeyboardButton("–ú–µ–Ω—å—à–µ")
    correct = types.KeyboardButton("–£–≥–∞–¥–∞–ª!")
    markup.add(higher, lower, correct)

    bot.send_message(message.chat.id, f"–ó–∞–¥—É–º–∞–π —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100. –Ø –±—É–¥—É –µ–≥–æ —É–≥–∞–¥—ã–≤–∞—Ç—å.\n–ú–æ—ë –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {guess_number}?", reply_markup=markup)

    bot.register_next_step_handler(message, handle_bot_guess_response)

def handle_bot_guess_response(message):
    global guess_min, guess_max, guess_number

    if message.text == "–ë–æ–ª—å—à–µ":
        guess_min = guess_number + 1
    elif message.text == "–ú–µ–Ω—å—à–µ":
        guess_max = guess_number - 1
    elif message.text == "–£–≥–∞–¥–∞–ª!":
        bot.send_message(message.chat.id, "–£—Ä–∞! –Ø —É–≥–∞–¥–∞–ª!", reply_markup=types.ReplyKeyboardRemove())
        show_main_menu(message)  # –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        return
    else:
        bot.send_message(message.chat.id, "–ù–µ –ø–æ–Ω–∏–º–∞—é. –í—ã–±–µ—Ä–∏ '–ë–æ–ª—å—à–µ', '–ú–µ–Ω—å—à–µ' –∏–ª–∏ '–£–≥–∞–¥–∞–ª!'", reply_markup=types.ReplyKeyboardRemove())
        return

    if guess_min > guess_max:
        bot.send_message(message.chat.id, "–¢—ã –º–µ–Ω—è –æ–±–º–∞–Ω—ã–≤–∞–µ—à—å! –ß–∏—Å–ª–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –±–æ–ª—å—à–µ –∏ –º–µ–Ω—å—à–µ!", reply_markup=types.ReplyKeyboardRemove())
        return

    guess_number = (guess_min + guess_max) // 2
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    higher = types.KeyboardButton("–ë–æ–ª—å—à–µ")
    lower = types.KeyboardButton("–ú–µ–Ω—å—à–µ")
    correct = types.KeyboardButton("–£–≥–∞–¥–∞–ª!")
    markup.add(higher, lower, correct)
    bot.send_message(message.chat.id, f"–¢–æ–≥–¥–∞ –º–æ—ë —Å–ª–µ–¥—É—é—â–µ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {guess_number}?", reply_markup=markup)
    bot.register_next_step_handler(message, handle_bot_guess_response)

# --- –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≥–∞–¥—ã–≤–∞–µ—Ç) ---
def user_guess_number(message):
    global secret_number, attempts
    secret_number = random.randint(1, 100)
    attempts = 0
    bot.send_message(message.chat.id, "–Ø –∑–∞–≥–∞–¥–∞–ª —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100. –ü–æ–ø—Ä–æ–±—É–π —É–≥–∞–¥–∞—Ç—å!")
    bot.register_next_step_handler(message, handle_user_guess)

def handle_user_guess(message):
    global secret_number, attempts
    try:
        guess = int(message.text)
        attempts += 1
        if guess < secret_number:
            bot.send_message(message.chat.id, "–ë–æ–ª—å—à–µ!")
            bot.register_next_step_handler(message, handle_user_guess)
        elif guess > secret_number:
            bot.send_message(message.chat.id, "–ú–µ–Ω—å—à–µ!")
            bot.register_next_step_handler(message, handle_user_guess)
        else:
            bot.send_message(message.chat.id, f"–£—Ä–∞! –¢—ã —É–≥–∞–¥–∞–ª —á–∏—Å–ª–æ {secret_number} –∑–∞ {attempts} –ø–æ–ø—ã—Ç–æ–∫!", reply_markup=types.ReplyKeyboardRemove())
            show_main_menu(message)  # –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

    except ValueError:
        bot.send_message(message.chat.id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100.")
        bot.register_next_step_handler(message, handle_user_guess)

# --- –û—Ä–µ–ª –∏ —Ä–µ—à–∫–∞ ---
def coin_flip(message):
    result = random.choice(["–û—Ä–µ–ª", "–†–µ—à–∫–∞"])
    bot.send_message(message.chat.id, f"–ü–æ–¥–±—Ä–∞—Å—ã–≤–∞—é –º–æ–Ω–µ—Ç–∫—É...\n–í—ã–ø–∞–ª–æ: {result}", reply_markup=types.ReplyKeyboardRemove())
    show_main_menu(message)

# --- –†—É—Å—Å–∫–∞—è —Ä—É–ª–µ—Ç–∫–∞ ---
def russian_roulette(message):
    bot.send_message(message.chat.id, "–ò–≥—Ä–∞–µ–º –≤ —Ä—É—Å—Å–∫—É—é —Ä—É–ª–µ—Ç–∫—É... –ü—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å!", reply_markup=types.ReplyKeyboardRemove())
    time.sleep(2)
    if random.randint(1, 6) == 1:
        bot.send_message(message.chat.id, "–ë–ê–•! –¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª...", reply_markup=types.ReplyKeyboardRemove())
    else:
        bot.send_message(message.chat.id, "–©–µ–ª–∫! –ü—Ä–æ–Ω–µ—Å–ª–æ...", reply_markup=types.ReplyKeyboardRemove())
    show_main_menu(message)

# --- –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ ---

def start_tic_tac_toe(message):
    global board, current_player
    board = ['‚¨ú'] * 9  # –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–æ—Å–∫—É –±–µ–ª—ã–º–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞–º–∏
    current_player = 'X'
    draw_board(message.chat.id)

def draw_board(chat_id):
    board_str = f"""
   {board[0]} | {board[1]} | {board[2]}
  ---+---+---
   {board[3]} | {board[4]} | {board[5]}
  ---+---+---
   {board[6]} | {board[7]} | {board[8]}
    """
    bot.send_message(chat_id, board_str, reply_markup=get_tic_tac_toe_markup())
    bot.send_message(chat_id, f"–•–æ–¥–∏—Ç {current_player}. –í—ã–±–µ—Ä–∏ –∫–ª–µ—Ç–∫—É (1-9).")

def get_tic_tac_toe_markup():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=3)
    for i in range(1, 10):
        markup.add(types.KeyboardButton(str(i))) # –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –Ω–∞–∂–∞—Ç—å
    return markup


def handle_tic_tac_toe_move(message):
    global board, current_player
    try:
        move = int(message.text)
        if 1 <= move <= 9:
            if board[move - 1] == '‚ùå' or board[move - 1] == '‚≠ï':
                bot.send_message(message.chat.id, "–≠—Ç–∞ –∫–ª–µ—Ç–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é.")
                draw_board(message.chat.id)
                return
            board[move - 1] = get_emoji(current_player) # –°—Ç–∞–≤–∏–º –∫—Ä–µ—Å—Ç–∏–∫ –∏–ª–∏ –Ω–æ–ª–∏–∫
            if check_winner():
                draw_board(message.chat.id)  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                bot.send_message(message.chat.id, f"üéâ {current_player} –≤—ã–∏–≥—Ä–∞–ª! üéâ", reply_markup=types.ReplyKeyboardRemove())
                show_main_menu(message)
                return
            if '‚¨ú' not in board: # Changed to check for white squares
                draw_board(message.chat.id)  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                bot.send_message(message.chat.id, "–ù–∏—á—å—è!", reply_markup=types.ReplyKeyboardRemove())
                show_main_menu(message)
                return

            # –•–æ–¥ –±–æ—Ç–∞
            current_player = 'O' if current_player == 'X' else 'X' # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∏–≥—Ä–æ–∫–∞
            bot_move = get_bot_move()
            board[bot_move] = get_emoji('O')  # –ë–æ—Ç —Å—Ç–∞–≤–∏—Ç –Ω–æ–ª–∏–∫

            if check_winner():
                draw_board(message.chat.id)  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                bot.send_message(message.chat.id, "üéâ –ë–æ—Ç –≤—ã–∏–≥—Ä–∞–ª! üéâ", reply_markup=types.ReplyKeyboardRemove())
                show_main_menu(message)
                return
            if '‚¨ú' not in board:  # Changed to check for white squares
                draw_board(message.chat.id)  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                bot.send_message(message.chat.id, "–ù–∏—á—å—è!", reply_markup=types.ReplyKeyboardRemove())
                show_main_menu(message)
                return

            current_player = 'X' # –°–Ω–æ–≤–∞ –¥–µ–ª–∞–µ–º –∏–≥—Ä–æ–∫–∞ - –∏–≥—Ä–æ–∫–æ–º
            draw_board(message.chat.id)

        else:
            bot.send_message(message.chat.id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ö–æ–¥. –í—ã–±–µ—Ä–∏ –∫–ª–µ—Ç–∫—É –æ—Ç 1 –¥–æ 9.")
            draw_board(message.chat.id)  # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–æ—Å–∫—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    except ValueError:
        bot.send_message(message.chat.id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 9.")
        draw_board(message.chat.id)

def get_bot_move():
    # –ü—Ä–æ—Å—Ç–æ–π –ò–ò: –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –∫–ª–µ—Ç–∫—É
    available_moves = [i for i, cell in enumerate(board) if cell == '‚¨ú']
    if not available_moves:
      available_moves = [i for i, cell in enumerate(board) if cell == ' ' ] # –µ—Å–ª–∏ –±–µ–ª—ã—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å

    return random.choice(available_moves)

def check_winner():
    winning_combinations = [
        (0, 1, 2), (3, 4, 5), (6, 7, 8),  # rows
        (0, 3, 6), (1, 4, 7), (2, 5, 8),  # columns
        (0, 4, 8), (2, 4, 6)  # diagonals
    ]
    for combo in winning_combinations:
        if board[combo[0]] == board[combo[1]] == board[combo[2]] != '‚¨ú' and board[combo[0]] != ' ':
            return True
    return False


def get_emoji(player):
    if player == 'X':
        return '‚ùå'
    elif player == 'O':
        return '‚≠ï'
    else:
        return '‚¨ú'  # Default to white square for empty cells


@bot.message_handler(func=lambda message: message.text.isdigit() and 1 <= int(message.text) <= 9)
def handle_tic_tac_toe_input(message):
    handle_tic_tac_toe_move(message)

# --- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---
if __name__ == '__main__':
    bot.infinity_polling()